---
title: "Putting_Pensions_Together"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Putting_Pensions_Together}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, eval=FALSE}
library(tidyverse)
library(pensionfinanceLi)
data(ret);data(retr)
```

In our setting we assume a female (`gender=1`), who is currently 42 (`c_age=42`) years of age, and has the following (choice) parameters set:

* `ret_age <- 65`
* `w3 <- setNames(c(.25,.25,.25,.25,0),c("msci","b10","recom","libor","infl"))`
* `c <- .6`
* `c2 <- .12`
* `nu2 <- .5`
* `nu3 <- .2`

Additionally, her parameters are set to:

* `w0 <- 300000`
* `li <- 100000`
* `lg <- 0.01`
* `c1 <- 0.07`
* `s1 <- c(20,70000)`
* `s2 <- 300000`
* `s3 <- 30000`
* `w2 <- setNames(c(.30,.30,.30,.10,0),c("msci","b10","recom","libor","infl"))`
* `rho2 <- .05`
* `rho3 <- .04`
* `ret <- ret[,,1:10]`
* `retr <- retr[,,1:10]`
* `psi <- 0.015`
* `alpha <- 0.96`
* `beta <- .75`

```{r set_parameters, eval=FALSE}
ret_age <- 65
w3 <- setNames(c(.25,.25,.25,.25,0),c("msci","b10","recom","libor","infl"))
c <- .6
c2 <- .12
nu2 <- .5
nu3 <- .2

c_age <- 42
gender <- 1
w0 <- 300000
li <- 100000
lg <- 0.01
c1 <- 0.07
s1 <- c(20,70000)
s2 <- 300000
s3 <- 30000
w2 <- setNames(c(.30,.30,.30,.10,0),c("msci","b10","recom","libor","infl"))
rho2 <- .05
rho3 <- .04
ret <- ret
retr <- retr
psi <- 0.015
alpha <- 0.96
beta <- .75
delta <- .02
wealth_at_ret_age <- 100000
```

# Cash-Flows and Tax Payments

We will use the following naming convention as in our [UNPIE](unpie.eu) project:
* time of calculation (`age=c_age`) is `t=0`
* time of retirement (`age=ret_age`) is `t=T` and `n=0`
* end of timeline (`age=122`) is `t=122-c_age` and `n=122-ret_age`
* time is always the end of the year (so at `age=ret_age` the first yearly pension payment will be made, and at `age=c_age` the first contribution to the pension system will be made)


## Cash-Flows during Savings-Phase


## Cash-Flows during Payment-Phase

### First pillar

To determine the first pillar pension, we need 
* the number of contribution years until current age `c_age` and the average historical income, as well as
* the current income `li` and the expected growth rate of current income `lr`
to determine the total contribution to the first pillar. Thereby we mix average (nominal) past and future real income to determine the entire contribution to the first pillar system. After the start of the pension payments, we use "Russian" inflation adjustment where running pension in real terms decreases by half the inflation rate.

```{r first_pillar, eval=FALSE}
sav_years <- ret_age-c_age
laborincome <- li*(1+lg)^(seq(sav_years))

# create tibble holding all information
fp <- fpCF(ret_age,c_age,li,lg,s1,ret)
cashflows <- bind_rows(
              tibble("age"=seq(c_age-s1[1],c_age-1),
                     name=rep("average income t<0",s1[1]),
                     val=c(rep(s1[2],s1[1]))),
              tibble("age"=seq(c_age,ret_age-1),
                     name=rep("income t>0 (nominal)",length(c_age:(ret_age-1))),
                     val=laborincome),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg first pillar pension",122-ret_age+1),
                     val=rowMeans(fp)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg +sd first pillar pension",122-ret_age+1),
                     val=rowMeans(fp)+apply(fp,1,sd)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg -sd first pillar pension",122-ret_age+1),
                     val=rowMeans(fp)-apply(fp,1,sd))
              
)
wealth <- tibble("age"=rep(ret_age,ncol(fp)),"fp_Wealth"=fp[1,]/rho2)

cashflows %>% ggplot(aes(x=age,y=val,color=name)) +
  geom_line() +
  geom_vline(xintercept = c_age) +
  geom_vline(xintercept = ret_age) +
  ylab("cash flows/income") +
  xlab("age")
```
### Second pillar

For second pillar pension calculations, we need:
* average contributions already paid to the second pillar `s2` (can be directly read from the report)
* the fractional contribution of income to the second pillar `c2`
* the portfolios allocation in the second pillar (fixed, averaged across reported Swiss pension funds)
* the average (real) portfolio performance for investments in the second pillar `retr` (we assume quartiles 2 and 3 to get the average investment return over all scenarios and all times, and quartiles 1 and 4 to be adjusted by +- 0.02)

Payments are doubled by the employer and - together with initial savings in second pillar `s2` invested using `w2` until retirement `ret_age`. Then the pension savings in the second pillar can be consumed as a lumpsum and in form of a pension annuity with given conversion rate `rho2` (adjusted for early/late retirement). We assume that pension payments are not adjusted for inflation and - therefore - decrease in real terms (depending on the inflation scenario)

```{r second_pillar, eval=FALSE}
tp <- tpCFret(ret_age = ret_age,c_age = c_age,w3 = w3,alpha = alpha,
              wealth_at_ret_age = wealth_at_ret_age,retr = retr,rho3 = rho3,psi = psi)

wealth <- cbind(wealth,"sp_wealth"=sp$wealth)
cashflows <- bind_rows(cashflows,
              tibble("age"=ret_age,
                     name="avg second pillar lumpsum",
                     val=mean(sp$lumpsum)),
              tibble("age"=ret_age,
                     name="avg +sd second pillar lumpsum",
                     val=mean(sp$lumpsum) + sd(sp$lumpsum)),
              tibble("age"=ret_age,
                     name="avg -sd second pillar lumpsum",
                     val=mean(sp$lumpsum) - sd(sp$lumpsum)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg first second pension",122-ret_age+1),
                     val=rowMeans(sp$pension)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg +sd first second pension",122-ret_age+1),
                     val=rowMeans(sp$pension)+apply(sp$pension,1,sd)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg -sd first second pension",122-ret_age+1),
                     val=rowMeans(sp$pension)-apply(sp$pension,1,sd))
              
)
cashflows %>% filter(!grepl("lumpsum",name)) %>% ggplot(aes(x=age,y=val,color=name)) +
  geom_line() +
  geom_vline(xintercept = c_age) +
  geom_vline(xintercept = ret_age) +
  ylab("cash flows/income") +
  xlab("age")

```
### Third pillar

```{r third_pillar, eval=FALSE}

tp <- tpCFret(ret_age = ret_age,c_age = c_age,w3 = w3,alpha = alpha,
              wealth_at_ret_age = wealth_at_ret_age,retr = retr,rho3 = rho3,psi = psi)

sp <- spCF(ret_age,nu2,c_age,c2,li,lg,w2,ret,retr,s2,rho2)
wealth <- cbind(wealth,"sp_wealth"=sp$wealth)
cashflows <- bind_rows(cashflows,
              tibble("age"=ret_age,
                     name="avg second pillar lumpsum",
                     val=mean(sp$lumpsum)),
              tibble("age"=ret_age,
                     name="avg +sd second pillar lumpsum",
                     val=mean(sp$lumpsum) + sd(sp$lumpsum)),
              tibble("age"=ret_age,
                     name="avg -sd second pillar lumpsum",
                     val=mean(sp$lumpsum) - sd(sp$lumpsum)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg first second pension",122-ret_age+1),
                     val=rowMeans(sp$pension)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg +sd first second pension",122-ret_age+1),
                     val=rowMeans(sp$pension)+apply(sp$pension,1,sd)),
              tibble("age"=seq(ret_age,122),
                     name=rep("avg -sd first second pension",122-ret_age+1),
                     val=rowMeans(sp$pension)-apply(sp$pension,1,sd))
              
)
cashflows %>% filter(!grepl("lumpsum",name)) %>% ggplot(aes(x=age,y=val,color=name)) +
  geom_line() +
  geom_vline(xintercept = c_age) +
  geom_vline(xintercept = ret_age) +
  ylab("cash flows/income") +
  xlab("age")

```


