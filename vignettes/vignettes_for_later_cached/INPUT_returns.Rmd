---
title: "Simulation of returns"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulation of returns}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE, eval=FALSE}
library(pensionfinanceLi)
library(dplyr)
library(tibble)
library(tidyquant)
library(knitr)
library(timetk)
```

This vignette explains in detail the variables and the processes used for the generation of investment returns in the model.

## Input Data

All data comes from Thomson Reuters Datastream. We specifically download the following series until 2018-12-31:

*  __MSCI World Total Return Index__ in CHF (Datastream Code: _MSWRLD$_, Data Code: _X(MSRI)~SF_), available monthly, starting on 1970-01-01
*  __FTSEUR1ST 300 SWITZERLAND S Total Return Index__ (Datastream Code: _FTECHFS_, Data Code: _X(RI)~SF_), available monthly, starting on 1986-01-01
*  __Swiss market (SMI) Total Return Index__ (Datastream Code: _SWISSMI_, Data Code: _X(RI)~SF_), available monthly, starting on 1993-05-01
*  __SW TOTAL 1-3 YEARS DS GOVT. INDEX Total Return Index__ (Datastream Code: _ASWGVG1_, Data Code: _X(RI)~SF_), available monthly, starting on 1980-12-01
*  __SW TOTAL 7-10 YEARS DS GOVT. INDEX Total Return Index__ (Datastream Code: _ASWGVG4_, Data Code: _X(RI)~SF_), available monthly, starting on 1980-12-01
*  __IBA CHF IBK. LIBOR 3M DELAYED - OFFERED RATE__ (Datastream Code: _BBCHF3M_, Data Code: _IO_), available monthly, starting on 1986-02-01
*  __SW CPI (2015M12=100) NADJ__ (Datastream Code: _SWCONPRCF_, Data Code: _IO_), available monthly, starting on 1970-01-15
*  __SW REAL ESTATE PRICE INDEX: ASK-RESIDENTIAL,RENTAL APARTMENTS__ (Datastream Code: _SWHPIRATF_, Data: non adjusted price index), available quarterly, starting on 1970-02-15
*  __SW REAL ESTATE PRICE INDEX: ASK - COMMERCIAL, OFFICE SPACE NADJ__ (Datastream Code: _SWHPIOFFF_, Data Code: non adjusted price index), available quarterly, starting on 1970-02-15

We merge all series together and save under the name `FINDATA` as package data.

After loading the data for further processing,

* we select the following indices in this order: _msci_,  _b10_, _recom_, _libor_, _infl_ 
* create a price index from libor as $\prod_{s=1}^{t} \left(1+\frac{r_s}{12}\right)$
* eliminate missing-values (which creates a quarterly series starting in Q2 1986 aligned in the middle of the quarter) 
* and calculate log-returns.

## Processing of Data

### Statistics of original process

We take all series as they are and calculate statistics. Because Real Estate performs bad, we adjust returns by 3 percent.

```{r eval=FALSE}
load("../data/FINDATA.rda")
D <- na.omit(merge(FINDATA$msci,FINDATA$b10,FINDATA$recom,cumprod(na.omit(1+FINDATA$libor/1200)),FINDATA$infl))
R <- na.omit(Return.calculate(D,method="log"))
R %>% cbind(.,R$recom+0.03/4) %>% table.AnnualizedReturns() %>% kable()
```
```{r eval=FALSE}
R %>% cbind(.,R$recom+0.03/4) %>% table.Stats() %>% kable()
```
```{r eval=FALSE}
R %>% cbind(.,R$recom+0.03/4) %>% cor() %>% kable()
```

```{r eval=FALSE}
R %>% cbind(.,R$recom+0.03/4) %>% chart.CumReturns(.,legend=TRUE)
```

Does this make sense economically?

### Estimation of VAR process

#### VAR process

```{r eval=FALSE}
R$recom <- R$recom+0.03/4 # add 0.03/4 to account for real estate, evtl. change - see nsi.xls add 4.1%
V <- tsDyn::lineVar(R , 1, model = "VAR")
B <- V$coefficients[1:5,2:6] # slope parameters
c <- V$coefficients[1:5,1] # intercepts
summary(V)
```

Therefore we get steady state:
```{r eval=FALSE}
s <- solve(diag(5)-B)%*%c
print(exp(s*4)-1) # sanity check whether the process makes econmically sense
```

<!-- #### VECM -->

<!-- ```{r} -->
<!-- D2 <- try.xts(100*exp(timeSeries::colCumsums(timeSeries::as.timeSeries(R)))) -->
<!-- V2 <- lineVar(D2 , 1, model = "VECM", estim = "ML") -->
<!-- B2 <- V2$coefficients[1:5,3:7] # slope parameters -->
<!-- c2 <- V2$coefficients[1:5,2] # intercepts -->
<!-- summary(V2) -->
<!-- ``` -->

## Simulation of Data

We go on by simulating data using functions from the package `tsDyn`.

```{r, eval=FALSE}
data(V)
retPA <- VARsim(V,simN=2,age.max = 10000)
```

and again analyse the output:

```{r, eval=FALSE}
D3 <- plyr::adply(retPA,.margins = 3,.fun = function(x){x}) %>% rownames_to_column() %>%
  rename(sim="X1",period=rowname) %>% as_tibble() %>% 
  filter(sim==2) %>% select(-sim) %>% mutate(period = make_date(as.numeric(period)-8001, 1, 1)) %>% timetk::tk_xts()
D3 %>% table.AnnualizedReturns()
```


```{r eval=FALSE}
data(ret)
# average over all slices [,,i]
retM <- apply(ret,c(1,2),mean)
# and now give statistics
retM %>% as_tibble() %>% mutate(period = make_date(as.numeric(row_number())+2000, 1, 1)) %>% timetk::tk_xts() %>% table.AnnualizedReturns()
```


