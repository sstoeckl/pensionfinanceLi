---
title: "Example_Cases"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example_Cases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(pensionfinanceLi)
library(MortalityTables)
data(ret);data(retr)
```

# Base Case (according to paper)

The first case is a 50-year old male (female) single with no children, having a yearly gross salary of `li=100'000` growing at a constant growth rate of `lg=0.01` per year, of which `c1=0.07` are deducted for mandatory contributions to social security (including first-pillar pensions), and `c2=0.12` are deducted (and matched exactly by the
employer) for second-pillar contributions. Non-disposable wealth is `W0=300'000`, and the insured has a risk aversion of `ra=8`, a time preference rate of `delta=0.02`, and plans to retire at `retage=65`. The insured has a working history of `20` years in the first pillar with an average income of `70'000` (`s1`), and `300'000` of savings in the second pillar. Currently, there are no savings in the third pillar, but no debt either. The investor weighs bequest utility relative to consumption utility at `beta=0.75`.

```{r eval=FALSE, echo=FALSE, messages=FALSE,warning=FALSE}
library(tictoc);library(beepr);library(tidyverse)
makeweights <- function(tw3){
  w3 <- setNames(rep(0,4),c("msci","b10","recom","libor"))
  w3[c("msci","b10","recom")] <- tw3
  w3["libor"] <- if (!abs(sum(tw3))==Inf) {1 - sum(tw3)}
  return(w3)
}
optim
nSim <- 100
#
outALL <- tibble(type=numeric(),gend=numeric(),opt=character(),c=numeric(),c2=numeric(),nu2=numeric(),nu3=numeric(),alpha=numeric(),
                 msci=numeric(),b10=numeric(),recom=numeric(),libor=numeric(),ret_age=numeric(),
                 method=character(),util=numeric(),convergence=numeric(),nSim=numeric())
for (type in 1:3){
  for (gend in 0:1){
    .load_parameters(gend=gend,type=type)
    cat("Running type ",type," and gend ",gend,"!\n")
    # 1) Full Scale Optimization
        tic() # c(c, c2, nu2, nu3, alpha, w3)
      outLC <- optimalLC(initial_values = c(0.5,0.1,0.5,0.5,1,rep(0,3)),upper_bounds=NULL,lower_bounds=NULL,
                       ret_age=ret_age,
                       ra=ra,delta=delta,beta=bbeta,c_age=c_age,gender=gender,gender_mortalityTable=gender_mortalityTable,
                       w0=w0,CF=CF,li=li,lg=lg,c1=c1,s1=s1,s2=s2,s3=s3,w2=w2,rho2=rho2,rho3=rho3,ret=ret[,,1:nSim],retr=retr[,,1:nSim],psi=psi,trace=1)
        toc()
        beep()
        names(outLC)[3:7] <- c("c","c2","nu2","nu3","alpha"); names(outLC)[c(12)] <- c("util")
      outALL <- bind_rows(outALL,c("opt"="LC","type"=type,"gend"=gend,outLC[c("c","c2","nu2","nu3","alpha")],makeweights(outLC[c("par6","par7","par8")]),
                                   outLC[c("method")],outLC[c("util","convergence")],"nSim"=nSim))
    # 2) Only some Parameters
      tic() # c(c, alpha, w3)
    outwc <- optimalwc(initial_values = unname(unlist(c(outLC[c("c","alpha")],outLC[c("par6","par7","par8")]))),upper_bounds=NULL,lower_bounds=NULL,
                 ret_age=ret_age,c2=c2,nu2=nu2,nu3=nu3,
                 ra=ra,delta=delta,beta=bbeta,c_age=c_age,gender=gender,gender_mortalityTable=gender_mortalityTable,
                 w0=w0,CF=CF,li=li,lg=lg,c1=c1,s1=s1,s2=s2,s3=s3,w2=w2,rho2=rho2,rho3=rho3,ret=ret[,,1:nSim],retr=retr[,,1:nSim],psi=psi,trace=1)
      toc()
      beep()
      names(outwc)[3:4] <- c("c","alpha"); names(outwc)[c(8)] <- c("util")
    outALL <- bind_rows(outALL,c("opt"="wc","type"=type,"gend"=gend,outwc["c"],"c2"=c2,"nu2"=nu2,"nu3"=nu3,outwc["alpha"],
                                 makeweights(outwc[c("par3","par4","par5")]),"ret_age"=ret_age,
                                 outwc[c("method")],outwc[c("util","convergence")],"nSim"=nSim))
    # 3) Only weights
      tic() # c(w3)
    outw <- optimalw(unname(unlist(outwc[c("par3","par4","par5")])),upper_bounds=NULL,lower_bounds=NULL,
                 ret_age=ret_age,cc=cc,c2=c2,nu2=nu2,nu3=nu3,
                 ra=ra,delta=delta,alpha=aalpha,beta=bbeta,c_age=c_age,gender=gender,gender_mortalityTable=gender_mortalityTable,
                 w0=w0,CF=CF,li=li,lg=lg,c1=c1,s1=s1,s2=s2,s3=s3,w2=w2,rho2=rho2,rho3=rho3,ret=ret[,,1:nSim],retr=retr[,,1:nSim],psi=psi,trace=0)
      toc()
      beep()
      names(outw)[c(6)] <- c("util")
    outALL <- bind_rows(outALL,c("opt"="w","type"=type,"gend"=gend,"c"=cc,"c2"=c2,"nu2"=nu2,"nu3"=nu3,"alpha"=aalpha,
                                 makeweights(outw[c("par1","par2","par3")]),"ret_age"=ret_age,
                                 outw[c("method")],outw[c("util","convergence")],"nSim"=nSim))
    
  }
}


```

```{r eval=FALSE}

```

```{r eval=FALSE}
library(tidyverse)
#data(ret);data(retr)
tw3 <- unlist(outLC[c("p6","p7","p8")])
warnings<-TRUE
ret_age=round(outLC[1,"ret_age"])
cc=outLC[1,"c"] 
c2=outLC[1,"c2"]
nu2=outLC[1,"nu2"]
nu3=outLC[1,"nu3"]
aalpha=outLC[1,"alpha"]
# research pathological case
# profvis({
util(ret_age=ret_age,c=cc,c2=c2,nu2=nu2,nu3=nu3,tw3=tw3,#unlist(outw["Nelder-Mead",1:3]),
          ra=ra,delta=delta,alpha=aalpha,beta=bbeta,c_age=c_age,gender=gender,gender_mortalityTable=gender_mortalityTable,
          w0=w0,CF=CF,li=li,lg=lg,c1=c1,s1=s1,s2=s2,s3=s3,w2=w2,rho2=rho2,rho3=rho3,ret=ret,retr=retr,psi=psi)
  # })
############### Now execute util and subsequently totalCF
  w3 <- setNames(rep(0,5),c("msci","b10","recom","libor","infl"))
  w3[c("msci","b10","recom")] <- tw3
  w3["libor"] <- if (!abs(sum(tw3))==Inf) {1 - sum(tw3)}
w3
###############
### UTILITY
tcf <- totalCF(ret_age = ret_age, w3 = w3, c = cc, c2 = c2,
                   nu2 = nu2, nu3 = nu3, c_age = c_age, gender = gender,
                   w0 = w0, li = li, lg = lg, c1 = c1, s1 = s1, s2 = s2, s3 = s3,
                   w2 = w2, rho2 = rho2, rho3 = rho3, ret = ret, retr = retr, psi = psi, alpha = aalpha, warnings=warnings)
    delta_vec <- (1-delta)^(seq(1,(122-c_age+1)))
        names(delta_vec) <- (c_age):122
      # cumulative survival probabilities
      sur <- cumprod(1-gender_mortalityTable[(c_age-1):(length(gender_mortalityTable)-1)])
      #########################################
      ## 3. Calculate utilities
      # find those that have negative cons or wealth
      wealth <- rbind(tcf$wealth_before_ret,tcf$wealth_after_ret)
      uncondmort <- c(1,sur)*gender_mortalityTable[(c_age-1):length(gender_mortalityTable)]
      uncondmort <- uncondmort[-length(uncondmort)]
    ### 3a. utility of entire lifetime consumption (scaled for numerical reasons)
      UC <- apply(tcf$cons,2,function(x){sum((((x+max(10000,w0))/max(10000,w0))^(1-ra))/(1-ra)%*%delta_vec*sur)})
      ### 3b. utility of bequest
      UB <- apply(wealth,2,function(x){sum((((x+max(10000,w0))/max(10000,w0))^(1-ra))/(1-ra)%*%delta_vec*uncondmort)})
      ### 3c. Expected utility
      EU <- mean(UC+bbeta*UB)
  ## Analysis
  which.min(UC)
  UC[which.min(UC)]
  tcf$cons[,which.min(UC)]
################
    
  



```




# Parameters held constant across examples

